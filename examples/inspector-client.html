<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Fortistate Inspector</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      :root{--bg-start:#ffffff; --bg-end: rgba(241,245,249,0.9); --card: rgba(15,23,42,0.04); --muted:#64748b; --accent:#3b82f6}
      body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg-start),var(--bg-end));color:#071023;margin:0;padding:28px;}
      .wrap{max-width:980px;margin:0 auto}
      header{display:flex;align-items:center;gap:16px}
      h1{margin:0;font-weight:700}
      .sub{color:var(--muted);margin-top:6px}
      .brand-accent{height:6px;border-radius:6px;background:linear-gradient(90deg,var(--accent),#60a5fa);margin:18px 0}
      #stores{display:flex;flex-wrap:wrap;gap:12px;margin-top:18px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(243,246,249,0.85));padding:14px;border-radius:12px;min-width:260px;box-shadow:0 6px 18px rgba(16,24,40,0.06);border:1px solid rgba(59,130,246,0.06);transition:transform .18s ease, box-shadow .18s ease}
  .card:hover{transform:translateY(-6px);box-shadow:0 14px 40px rgba(16,24,40,0.12)}
  .key{font-weight:700;color:var(--accent);display:flex;align-items:center;gap:8px}
  .value{color:#0f1724;margin-top:8px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', monospace;font-size:13px}
  .controls{margin-top:10px;display:flex;gap:8px;align-items:center}
  textarea.jsonedit{width:100%;height:88px;border-radius:8px;border:1px solid rgba(16,24,40,0.06);padding:8px;font-family:inherit;font-size:13px}
  button.ghost{background:transparent;border:1px solid rgba(16,24,40,0.06);padding:6px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
  button.primary{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  /* icon button variant */
  .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;border:1px solid rgba(16,24,40,0.06);background:transparent;padding:4px;cursor:pointer}
  .icon-btn.primary{background:linear-gradient(180deg,var(--accent),#2563eb);color:#fff;border:none}
  .icon-btn svg{width:18px;height:18px;display:block}
  .token-row{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  .token-row input{padding:6px 8px;border-radius:8px;border:1px solid rgba(16,24,40,0.06);flex:1}
      .log{background:linear-gradient(180deg, rgba(15,23,42,0.02), rgba(15,23,42,0.01));padding:10px;border-radius:8px;color:var(--muted);margin-top:18px;max-height:200px;overflow:auto;border:1px solid rgba(16,24,40,0.04)}
      button.reload{background:transparent;border:1px solid rgba(59,130,246,0.12);padding:6px 10px;border-radius:8px;color:var(--accent);cursor:pointer;transition:all .14s ease}
      button.reload:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(59,130,246,0.08)}
    </style>
  </head>
  <body>
      <div class="wrap">
      <header>
        <div>
          <h1>Fortistate Inspector</h1>
          <div class="sub">Live view of registered remote stores â€” edit values to push changes back to clients</div>
        </div>
  <div style="margin-left:auto"><button type="button" class="icon-btn" id="reloadBtn" aria-label="refresh" title="Refresh"> <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 12a8 8 0 1 0-2.1 4.9L20 20" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></button></div>
      </header>
      <div class="brand-accent" aria-hidden="true"></div>
      <div class="token-row" style="margin-top:14px">
        <input id="tokenInput" placeholder="Inspector token (optional)" aria-label="token" />
        <button class="icon-btn" id="applyToken" aria-label="apply-token" title="Apply token"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
      </div>
      <div id="stores"></div>
      <div class="log" id="log"></div>
    </div>
    <script>
      const logEl = document.getElementById('log')
      const stDiv = document.getElementById('stores')
      const reloadBtn = document.getElementById('reloadBtn')
      const log = (m) => { logEl.innerText = JSON.stringify(m, null, 2) + '\n' + logEl.innerText }

      function makeCard(key, value){
        const c = document.createElement('div'); c.className = 'card'
        const k = document.createElement('div'); k.className='key'; k.innerText = key
        const v = document.createElement('div'); v.className='value'; v.innerText = JSON.stringify(value)

        const ta = document.createElement('textarea'); ta.className = 'jsonedit'; ta.value = JSON.stringify(value, null, 2)
  const controls = document.createElement('div'); controls.className = 'controls'
  const upd = document.createElement('button'); upd.className = 'icon-btn primary'; upd.setAttribute('aria-label','update'); upd.setAttribute('title','Update'); upd.innerHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 7h16M4 12h8M4 17h8" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>'
  const rst = document.createElement('button'); rst.className = 'icon-btn'; rst.setAttribute('aria-label','reset'); rst.setAttribute('title','Reset'); rst.innerHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 12a9 9 0 1 0-3.2 6.8L21 21" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>'

        upd.addEventListener('click', async () => {
          let parsed
          try { parsed = JSON.parse(ta.value) } catch (e) { alert('Invalid JSON'); return }
          try {
            const token = (document.getElementById('tokenInput') || {}).value
            const headers = { 'Content-Type': 'application/json' }
            if (token) headers['x-fortistate-token'] = token
            const res = await fetch('/change', { method: 'POST', headers, body: JSON.stringify({ key, value: parsed }) })
            if (!res.ok) { const txt = await res.text(); log({ type: 'change:error', key, status: res.status, body: txt }) }
            else { log({ type: 'change:ok', key }) }
          } catch (e) { log({ type: 'change:error', key, error: String(e) }) }
        })

        rst.addEventListener('click', () => { ta.value = JSON.stringify(value, null, 2) })

        controls.appendChild(upd); controls.appendChild(rst)
        c.appendChild(k); c.appendChild(v); c.appendChild(ta); c.appendChild(controls)
        return c
      }
      async function loadRemoteStores(){
        try{
          const res = await fetch('/remote-stores')
          const js = await res.json()
          stDiv.innerHTML = ''
          for(const k of Object.keys(js || {})){
            stDiv.appendChild(makeCard(k, js[k]))
          }
        }catch(e){ stDiv.innerText = 'error' }
      }
      loadRemoteStores()
      const ws = new WebSocket((location.origin.replace(/^http/, 'ws')))
      ws.addEventListener('message', (ev) => {
        try { const data = JSON.parse(ev.data); log(data); loadRemoteStores() } catch (e) { log(ev.data) }
      })
      ws.addEventListener('open', () => log({ type: 'connected' }))
    reloadBtn.addEventListener('click', loadRemoteStores)
  document.getElementById('applyToken').addEventListener('click', () => { log({ type: 'token:applied' }) })
    </script>
  </body>
</html>
